name: Release

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+*"]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CARGO_TERM_COLOR: always

jobs:
  prepare_release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure draft release exists
        run: ./.github/workflows/upload_asset.sh --ensure-release "$GITHUB_TOKEN"

  macos:
    needs: prepare_release
    runs-on: macos-26
    environment: macOS Sign
    env:
      ALACRITTY_CODESIGN_FLAGS: --timestamp --options runtime
      ALACRITTY_NOTARIZE_PROFILE: ${{ vars.ALACRITTY_NOTARIZE_PROFILE || 'Default Notary' }}

    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: brew install scdoc
      - name: Install ARM target
        run: rustup update && rustup target add aarch64-apple-darwin && rustup target add x86_64-apple-darwin
      - name: Install signing certificate
        env:
          MACOS_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
          MACOS_CODESIGN_IDENTITY: ${{ secrets.MACOS_CODESIGN_IDENTITY }}
        run: |
          set -euo pipefail
          if [ -z "$MACOS_CERTIFICATE_BASE64" ] || [ -z "$MACOS_CERTIFICATE_PASSWORD" ] || [ -z "$MACOS_KEYCHAIN_PASSWORD" ] || [ -z "$MACOS_CODESIGN_IDENTITY" ]; then
            echo "macOS signing secrets are missing. Configure MACOS_CERTIFICATE_BASE64, MACOS_CERTIFICATE_PASSWORD, MACOS_KEYCHAIN_PASSWORD, and MACOS_CODESIGN_IDENTITY." >&2
            exit 1
          fi
          CERT_PATH="$RUNNER_TEMP/signing-cert.p12"
          echo "$MACOS_CERTIFICATE_BASE64" | base64 --decode > "$CERT_PATH"
          KEYCHAIN_PATH="$RUNNER_TEMP/alacritty-signing.keychain-db"
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$MACOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH" >/dev/null
          existing_keychains=$(security list-keychains -d user | tr -d '"')
          security list-keychains -d user -s "$KEYCHAIN_PATH" $existing_keychains
          security default-keychain -s "$KEYCHAIN_PATH"
          rm -f "$CERT_PATH"
          echo "MACOS_CODESIGN_KEYCHAIN=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "ALACRITTY_CODESIGN_IDENTITY=$MACOS_CODESIGN_IDENTITY" >> "$GITHUB_ENV"
          echo "ALACRITTY_CODESIGN_FLAGS=${ALACRITTY_CODESIGN_FLAGS}" >> "$GITHUB_ENV"
      - name: Configure notarization credentials
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZE_APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.MACOS_NOTARIZE_TEAM_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.MACOS_NOTARIZE_APP_PASSWORD }}
          APPLE_KEYCHAIN_PROFILE: ${{ env.ALACRITTY_NOTARIZE_PROFILE }}
        run: |
          set -euo pipefail
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_TEAM_ID" ] || [ -z "$APP_SPECIFIC_PASSWORD" ]; then
            echo "macOS notarization secrets are missing. Configure MACOS_NOTARIZE_APPLE_ID, MACOS_NOTARIZE_TEAM_ID, and MACOS_NOTARIZE_APP_PASSWORD." >&2
            exit 1
          fi
          if [ -z "${MACOS_CODESIGN_KEYCHAIN:-}" ] || [ ! -f "$MACOS_CODESIGN_KEYCHAIN" ]; then
            echo "Signing keychain not available for notarization credential storage." >&2
            exit 1
          fi
          if xcrun notarytool list-profiles --keychain "$MACOS_CODESIGN_KEYCHAIN" | grep -F "Name: $APPLE_KEYCHAIN_PROFILE" >/dev/null 2>&1; then
            echo "Notarization profile '$APPLE_KEYCHAIN_PROFILE' already present"
          else
            xcrun notarytool store-credentials "$APPLE_KEYCHAIN_PROFILE" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APP_SPECIFIC_PASSWORD" \
              --keychain "$MACOS_CODESIGN_KEYCHAIN"
            echo "Stored notarization profile '$APPLE_KEYCHAIN_PROFILE'"
          fi
          echo "ALACRITTY_NOTARIZE_PROFILE=$APPLE_KEYCHAIN_PROFILE" >> "$GITHUB_ENV"
      - name: Test
        run: cargo test --release --target=x86_64-apple-darwin
      - name: Build ARM
        run: cargo build --release --target=aarch64-apple-darwin
      - name: Make DMG
        run: make dmg-universal
      - name: Cleanup signing keychain
        if: always()
        run: |
          set -euo pipefail
          if [ -n "${MACOS_CODESIGN_KEYCHAIN:-}" ] && [ -f "$MACOS_CODESIGN_KEYCHAIN" ]; then
            security delete-keychain "$MACOS_CODESIGN_KEYCHAIN"
          fi
      - name: Upload Application
        run: |
          mv ./target/release/osx/Alacritty.dmg ./Alacritty-${GITHUB_REF##*/}.dmg
          ./.github/workflows/upload_asset.sh ./Alacritty-${GITHUB_REF##*/}.dmg $GITHUB_TOKEN

  windows:
    needs: prepare_release
    runs-on: windows-latest

    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4
      - name: Test
        run: cargo test --release
      - name: Build
        run: cargo build --release
      - name: Upload portable executable
        run: |
          cp ./target/release/alacritty.exe ./Alacritty-${GITHUB_REF##*/}-portable.exe
          ./.github/workflows/upload_asset.sh \
            ./Alacritty-${GITHUB_REF##*/}-portable.exe $GITHUB_TOKEN
      - name: Install WiX
        run: dotnet tool install --global wix --version 4.0.5
      - name: Create msi installer
        run: |
          wix extension add WixToolset.UI.wixext/4.0.5 WixToolset.Util.wixext/4.0.5
          wix build -arch "x64" -ext WixToolset.UI.wixext -ext WixToolset.Util.wixext \
          -out "./Alacritty-${GITHUB_REF##*/}-installer.msi" "alacritty/windows/wix/alacritty.wxs"
      - name: Upload msi installer
        run: |
          ./.github/workflows/upload_asset.sh \
            ./Alacritty-${GITHUB_REF##*/}-installer.msi $GITHUB_TOKEN

  linux:
    needs: prepare_release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get install cmake pkg-config libfreetype6-dev libfontconfig1-dev \
            libxcb-xfixes0-dev libxkbcommon-dev python3 scdoc
      - name: Test
        run: cargo test --release
      - name: Generate manpages
        run: |
          scdoc < extra/man/alacritty.1.scd | gzip -c > "./alacritty.1.gz"
          scdoc < extra/man/alacritty-msg.1.scd | gzip -c > "./alacritty-msg.1.gz"
          scdoc < extra/man/alacritty.5.scd | gzip -c > "./alacritty.5.gz"
          scdoc < extra/man/alacritty-bindings.5.scd | gzip -c > "./alacritty-bindings.5.gz"
      - name: Upload Assets
        run: |
          mv ./extra/logo/alacritty-term.svg ./Alacritty.svg
          ./.github/workflows/upload_asset.sh ./Alacritty.svg $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./alacritty.1.gz $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./alacritty-msg.1.gz $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./alacritty.5.gz $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./alacritty-bindings.5.gz $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./extra/completions/alacritty.bash $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./extra/completions/alacritty.fish $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./extra/completions/_alacritty $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./extra/linux/Alacritty.desktop $GITHUB_TOKEN
          ./.github/workflows/upload_asset.sh ./extra/alacritty.info $GITHUB_TOKEN
